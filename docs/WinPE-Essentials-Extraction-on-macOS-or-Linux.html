
<!doctype html>
<html lang="en">




<head>
    <title>How to WinPE Essentials Extraction on macOS or Linux - Attune Automation</title>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="title"
          content="How to WinPE Essentials Extraction on macOS or Linux - Attune Automation">
    <meta name="description"
          content="">
    <meta name="robots"
          content="follow, index, max-snippet:-1, max-video-preview:-1, max-image-preview:large">

    <meta property="og:locale" content="en_AU" />
    <meta property="og:type" content="article" />
    <meta property="og:title"
          content="HowTo WinPE Essentials Extraction on macOS or Linux - Attune Automation" />
    <meta property="og:description" content="" />
    <meta property="og:site_name" content="Attune Automation" />
    <meta property="article:section" content="IT Instruction" />

    <meta name="twitter:title"
          content="How to WinPE Essentials Extraction on macOS or Linux - Attune Automation" />
    <meta name="twitter:description" content="" />

    <link rel="icon" href="https://www.servertribe.com/wp-content/uploads/2020/10/cropped-server_tribe_favicon-32x32.png" sizes="32x32">
    <link rel="icon" href="https://www.servertribe.com/wp-content/uploads/2020/10/cropped-server_tribe_favicon-192x192.png" sizes="192x192">
    <link rel="apple-touch-icon" href="https://www.servertribe.com/wp-content/uploads/2020/10/cropped-server_tribe_favicon-180x180.png">
    <meta name="msapplication-TileImage" content="https://www.servertribe.com/wp-content/uploads/2020/10/cropped-server_tribe_favicon-270x270.png">
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"
          integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
          crossorigin="anonymous">
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
    <link rel="stylesheet" href="styles/style.css">

    <!-- Google tag (gtag.js) -->
    <script async
            src="https://www.googletagmanager.com/gtag/js?id=G-5TZQZNDJCD"></script>
    <script>
        window.dataLayer = window.dataLayer || [];

        function gtag() {
            dataLayer.push(arguments);
        }

        gtag('js', new Date());

        gtag('config', 'G-5TZQZNDJCD');
    </script>
</head>


<body>

<!-- Project NavBar -->

<div class="bg-white border-bottom box-shadow sticky-top mb-3">
<div class="container px-0">
    <div class="row px-0">
        <div class="col d-flex flex-column flex-lg-row align-items-center px-0
            py-3">
            <a class="navbar-brand my-0 mr-lg-auto"
                  href="https://www.servertribe.com/"
                  target="_blank">
                    <img
                        src="https://www.servertribe.com/wp-content/uploads/2022/06/AttuneLogoV2_powered_by.png"
                        alt="Attune - Powered by ServerTribe"
                        class="img-fluid navbar-img">
            </a>
            <nav class="my-2 my-lg-0 mr-lg-3">
                <a class="p-2 text-dark" href="http://doc.servertribe.com/"
                   target="_blank">
                    Documentation
                </a>
                <a class="p-2 text-dark"
                   href="https://discord.com/invite/3YpJsagqUn"
                   target="_blank">
                    Discord
                </a>
                <a class="p-2 text-dark" href="https://github.com/Attune-Automation"
                   target="_blank">
                    GitHub
                </a>
                <a class="p-2 text-dark" href="https://www.servertribe.com/learn/"
                   target="_blank">
                    Learn
                </a>
            </nav>
            <a class="btn btn-outline-primary"
               href="https://www.servertribe.com/download-attune-registration/"
               target="_blank">
                Download NOW!
            </a>
        </div>
    </div>
</div></div>

<!-- Project breadcrumbs -->

<!-- Project breadcrumbs -->
<div class="container px-0">
    <div class="row">
        <nav class="col px-0" aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="index.html">
                    Automate Windows Installation with autounattend
                    </a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    <strong>WinPE Essentials Extraction on macOS or Linux</strong>
                </li>
            </ol>
        </nav>
    </div>
</div>

<!-- Blueprint Header -->

<div class="container px-0">
    <!-- Blueprint name and description -->
    <div class="row">
        <div class="col px-0">
            <h1 class="text-left">
                How to WinPE Essentials Extraction on macOS or Linux
            </h1>
        </div>
    </div>

<!-- Blueprint Description -->
    <div class="row pt-4">
        <div class="col-6 px-0">
            <h6 class="text-left">
                This documentation is generated by
                <a href="https://www.servertribe.com/"
                    class="badge badge-primary"
                    target="_blank">
                    Attune
                </a>
            </h6>
        </div>
        <div class="col-6 align-self-end text-right px-0">
            <h6 class="text-right">
                <a href="https://www.youtube.com/@servertribe"
                    class="badge badge-secondary"
                    target="_blank">
                    YouTube
                </a>
                <a href="https://github.com/Attune-Automation"
                    class="badge badge-secondary"
                    target="_blank">
                    GitHub
                </a>
                <a href="https://discord.com/invite/3YpJsagqUn"
                    class="badge badge-secondary"
                    target="_blank">
                    Discord
                </a>
                <a href="https://www.linkedin.com/company/servertribe/"
                    class="badge badge-secondary"
                    target="_blank">
                    LinkedIn
                </a>
                <a href="http://doc.servertribe.com/"
                    class="badge badge-secondary"
                    target="_blank">
                    Documentation
                </a>
            </h6>
        </div>
    </div>
    <hr>
</div>

<div class="documentation">
    <div class="container px-0">
        <div class="row">

<!-- Blueprint ToC -->


            <div class="toc col-lg-2 px-0 pr-5">
                <div class="container px-0 pt-3">
                    <p class="pb-2">
                        <strong>Contents</strong>
                    </p>
                    <p class="text-muted">
                        <a href="#top">
                            <strong>WinPE Essentials Extraction on macOS or Linux</strong>
                        </a>
                    </p>


    
        

                    <p class="text-muted pt-2">
                        <a href="#cleanuptemporarybuildfilesforwinpeplainisocreationonmacosorlinux">
                            <strong>Step 1 -</strong> Cleanup temporary build files for WinPE plain ISO creation on macOS or Linux
                        </a>
                    </p>
    
        

                    <p class="text-muted pt-2">
                        <a href="#unmountwinpeuefimountonmacosorlinux">
                            <strong>Step 1.1 -</strong> Unmount WinPE UEFI Mount on macOS or Linux
                        </a>
                    </p>

        

                    <p class="text-muted pt-2">
                        <a href="#unmountwindowsisoonmacosorlinux">
                            <strong>Step 1.2 -</strong> Unmount Windows ISO on macOS or Linux
                        </a>
                    </p>

        

                    <p class="text-muted pt-2">
                        <a href="#setwritepermissionstowinpeuefistagingonmacosorlinux">
                            <strong>Step 1.3 -</strong> Set Write Permissions to winpe_uefi_staging on macOS or Linux
                        </a>
                    </p>

        

                    <p class="text-muted pt-2">
                        <a href="#deletethebuilddirectoryonmacosorlinux">
                            <strong>Step 1.4 -</strong> Delete the build directory on macOS or Linux
                        </a>
                    </p>


        

                    <p class="text-muted pt-2">
                        <a href="#deploywindowsdvdisotobuildwinpeisodirectoryonmacosorlinux">
                            <strong>Step 2 -</strong> Deploy Windows DVD ISO to build-winpe-iso directory on macOS or Linux
                        </a>
                    </p>

        

                    <p class="text-muted pt-2">
                        <a href="#extractwindowsbootimgfrombuildwinpeisodirectoryforbiosbuildonmacosorlinux">
                            <strong>Step 3 -</strong> Extract Windows boot.img from build-winpe-iso directory for BIOS build on macOS or Linux
                        </a>
                    </p>

        

                    <p class="text-muted pt-2">
                        <a href="#mountwinserverdvdisoonmacosorlinux">
                            <strong>Step 4 -</strong> Mount Win Server DVD ISO on macOS or Linux
                        </a>
                    </p>

        

                    <p class="text-muted pt-2">
                        <a href="#confirmmkwinpeimgisinstalled">
                            <strong>Step 5 -</strong> Confirm mkwinpeimg is installed
                        </a>
                    </p>

        

                    <p class="text-muted pt-2">
                        <a href="#extractwinpeisofromwinimgdirectoryonmacosorlinux">
                            <strong>Step 6 -</strong> Extract WinPE ISO from winimg Directory on macOS or Linux
                        </a>
                    </p>

        

                    <p class="text-muted pt-2">
                        <a href="#extractwinpeisotostagingfolderonbuildwinpeisoonmacosorlinux">
                            <strong>Step 7 -</strong> Extract WinPE ISO to Staging Folder on build-winpe-iso on macOS or Linux
                        </a>
                    </p>

        

                    <p class="text-muted pt-2">
                        <a href="#copyfilesformkwinpeimgcompatibilitytowinpestagingonmacosorlinux">
                            <strong>Step 8 -</strong> Copy Files for mkwinpeimg Compatibility to WinPE Staging on macOS or Linux
                        </a>
                    </p>

        

                    <p class="text-muted pt-2">
                        <a href="#copybootimgtowinpestagingforbiosbuildonmacosorlinux">
                            <strong>Step 9 -</strong> Copy boot.img to winpe_staging for BIOS build on macOS or Linux
                        </a>
                    </p>

        

                    <p class="text-muted pt-2">
                        <a href="#lindeletesetupexefrombootwim">
                            <strong>Step 10 -</strong> LIN Delete setup.exe from boot.wim
                        </a>
                    </p>

        

                    <p class="text-muted pt-2">
                        <a href="#copywindowsefifilestowinpeuefistagingonmacosorlinux">
                            <strong>Step 11 -</strong> Copy Windows EFI Files to WinPE UEFI Staging on macOS or Linux
                        </a>
                    </p>

        

                    <p class="text-muted pt-2">
                        <a href="#createwinpeplainbiosisofromwinpestagingonmacosorlinux">
                            <strong>Step 12 -</strong> Create winpe_plain_bios.iso from winpe_staging on macOS or Linux
                        </a>
                    </p>

        

                    <p class="text-muted pt-2">
                        <a href="#createfat32winpeplainuefiisofromwinpestagingonlinuxworker">
                            <strong>Step 13 -</strong> Create FAT32 winpe_plain_uefi.iso from winpe_staging on Linux Worker
                        </a>
                    </p>
    
        

                    <p class="text-muted pt-2">
                        <a href="#changeownershipofwinpestagingdirectorytoattune">
                            <strong>Step 13.1 -</strong> Change Ownership of winpe_staging Directory to attune
                        </a>
                    </p>

        

                    <p class="text-muted pt-2">
                        <a href="#createwinpeplainuefiiso">
                            <strong>Step 13.2 -</strong> Create winpe_plain_uefi.iso
                        </a>
                    </p>

        

                    <p class="text-muted pt-2">
                        <a href="#mountwinpeplainuefiiso">
                            <strong>Step 13.3 -</strong> Mount winpe_plain_uefi.iso
                        </a>
                    </p>

        

                    <p class="text-muted pt-2">
                        <a href="#movewinpestagingtouefimount">
                            <strong>Step 13.4 -</strong> Move WinPE Staging to UEFI Mount
                        </a>
                    </p>

        

                    <p class="text-muted pt-2">
                        <a href="#unmountwinpeuefimountonmacosorlinux">
                            <strong>Step 13.5 -</strong> Unmount WinPE UEFI Mount on macOS or Linux
                        </a>
                    </p>


        

                    <p class="text-muted pt-2">
                        <a href="#createwinpeplainuefiisoonmacosworker">
                            <strong>Step 14 -</strong> Create winpe_plain_uefi.iso on macOS Worker
                        </a>
                    </p>

        

                    <p class="text-muted pt-2">
                        <a href="#cleanuptemporarybuildfilesforwinpeplainisocreationonmacosorlinux">
                            <strong>Step 15 -</strong> Cleanup temporary build files for WinPE plain ISO creation on macOS or Linux
                        </a>
                    </p>
    
        

                    <p class="text-muted pt-2">
                        <a href="#unmountwinpeuefimountonmacosorlinux">
                            <strong>Step 15.1 -</strong> Unmount WinPE UEFI Mount on macOS or Linux
                        </a>
                    </p>

        

                    <p class="text-muted pt-2">
                        <a href="#unmountwindowsisoonmacosorlinux">
                            <strong>Step 15.2 -</strong> Unmount Windows ISO on macOS or Linux
                        </a>
                    </p>

        

                    <p class="text-muted pt-2">
                        <a href="#setwritepermissionstowinpeuefistagingonmacosorlinux">
                            <strong>Step 15.3 -</strong> Set Write Permissions to winpe_uefi_staging on macOS or Linux
                        </a>
                    </p>

        

                    <p class="text-muted pt-2">
                        <a href="#deletethebuilddirectoryonmacosorlinux">
                            <strong>Step 15.4 -</strong> Delete the build directory on macOS or Linux
                        </a>
                    </p>



                </div>
            </div>

<!-- Blueprint Contents -->
            <div class="col-lg-8 pt-3">
                <div class="container">


        <div class="jumbotron">
            <p class="display-3 text-center">
                <strong>Automate This</strong>
            </p>
            <p class="lead text-center">
                Use the <strong>Attune GUI</strong> for your Scripts
            </p>
            <p class="lead">
                <ol>
                    <a href="https://www.servertribe.com/download-attune-registration/"
                        target="_blank">
                        <span class="badge badge-primary">1</span>
                        Download Attune
                        <i class="fa-solid fa-download fa-beat-fade" style="color: #0197ff;"></i>
                    </a>
                </ol>
                <ol>
                    <a href="https://github.com/attune-Automation/"
                        target="_blank">
                        <span class="badge badge-primary">2</span>
                         Copy the Attune Project URL
                         <i class="fa-brands fa-github fa-fade"></i>
                    </a>
                </ol>
                <ol>
                    <a href="https://servertribe-attune.readthedocs.io/en/latest/howto/design_workspace/clone_project.html"
                        target="_blank">
                        <span class="badge badge-primary">3</span>
                        Clone the Project in Attune
                         <i class="fa-solid fa-book fa-fade" style="color: #0197ff;"></i>
                    </a>
                </ol>
                <ol>
                    <a href="https://www.youtube.com/watch?v=GCWDI29rDV0"
                        target="_blank">
                        <span class="badge badge-primary">4</span>
                        Plan your Job(s)
                        <i class="fa-brands fa-youtube fa-fade" style="color: #0197ff;"></i>
                    </a>
                </ol>
                <ol>
                    <a href="https://www.youtube.com/watch?v=b7DhFcURkZg"
                        target="_blank">
                        <span class="badge badge-primary">5</span>
                        Run your Job(s)
                        <i class="fa-brands fa-youtube fa-fade" style="color: #0197ff;"></i>
                    </a>
                </ol>
            </p>
            <p class="lead text-center">
                You've automated: <strong>WinPE Essentials Extraction on macOS or Linux</strong>
            </p>
            <hr class="my-4 text-center">
            <div class="col px-0">
                <p class="text-center">
                    Get the most out of automation with our get started
                    videos, product demonstrations, and more.
                </p>
                <p class="lead text-center">
                    <a class="btn btn-primary btn-lg"
                       href="https://www.servertribe.com/learn/"
                       target="_blank"
                       role="button">
                        Learn Attune Automation
                    </a>
                </p>
            </div>
        </div>

        <div class="row">
            <p>The following steps will guide you through the manual process.</p>
        </div>

<!-- Blueprint Steps -->


        



                    <div class="row pt-5">
                        <h3 id="cleanuptemporarybuildfilesforwinpeplainisocreationonmacosorlinux">
                            <a href="#cleanuptemporarybuildfilesforwinpeplainisocreationonmacosorlinux">
                                <strong>Step 1 -</strong> Cleanup temporary build files for WinPE plain ISO creation on macOS or Linux
                            </a>
                        </h3>
                    </div>

                    <div class="row">
                        <div class="description col px-0">
                            <p>
                                <p>Unmount any existing WinPE or Windows ISO mounts. </p>
<p>Set appropriate write permissions to enable modifications in the 
working directory.</p>
<p>Delete any remaining build files.</p>
                            </p>
                        </div>
                    </div>





    




    



                    <div class="row pt-5">
                        <h4 id="unmountwinpeuefimountonmacosorlinux">
                            <a href="#unmountwinpeuefimountonmacosorlinux">
                                <strong>Step 1.1 -</strong> Unmount WinPE UEFI Mount on macOS or Linux
                            </a>
                        </h4>
                    </div>

                    <div class="row">
                        <div class="description col px-0">
                            <p>
                                <p>For a linux system, the <code>umount</code> command detaches the mentioned file system 
from the file hierarchy.</p>
<p>For a macOS system, the <code>hdiutil detach</code> command detaches a disk image and 
terminates any associated processes.</p>
                            </p>
                        </div>
                    </div>










                        <div class="row">
                            <p>
                                Connect via ssh:
                            </p>
                        </div>
                        <div class="row py-1">
                            <code class="language-sql">
ssh {automationworkerlinuxuserroot}@{automationworkerlinuxnode}
                            </code>
                        </div>



    



    <div class="row">
        <p>
            Execute the following script:
        </p>
    </div>
    <div class="row">
        <div class="col px-0">
            <pre>
                <code class="language-sql py-0">
MOUNT_PATH=&quot;{automationWorkerLinuxBaseDirectory}/build-winpe-iso/uefi_mount&quot;

if [[ -f /etc/redhat-release ]] || [[ -f /etc/lsb-release ]] || [[ -f /etc/debian_version ]]
then
    
    if df -h | grep --ignore-case --quiet &quot;$(echo ${MOUNT_PATH}/*)&quot;
    then
    
        umount --verbose &quot;$(echo ${MOUNT_PATH}/*)&quot;
        chmod -R a+w &quot;${MOUNT_PATH}&quot;
        
    else
    
        echo &quot;${MOUNT_PATH} is not mounted. Skipping.&quot;
    fi

elif [[ &quot;Darwin&quot; == &quot;$(uname)&quot; ]]
then

    if [[ $(find ${MOUNT_PATH}/*  2&gt; /dev/null | wc -l) -gt 10 ]]
    then
    
        hdiutil detach &quot;$(echo ${MOUNT_PATH}/*)&quot;
    else
    
        echo &quot;${MOUNT_PATH} is not mounted. Skipping.&quot;
    fi

else
    
    echo &quot;Unsupported operating system.&quot;
    exit 1
fi
                </code>
            </pre>
        </div>
    </div>





    



                    <div class="row pt-5">
                        <h4 id="unmountwindowsisoonmacosorlinux">
                            <a href="#unmountwindowsisoonmacosorlinux">
                                <strong>Step 1.2 -</strong> Unmount Windows ISO on macOS or Linux
                            </a>
                        </h4>
                    </div>

                    <div class="row">
                        <div class="description col px-0">
                            <p>
                                <p>For a linux system, the <code>umount</code> command detaches the mentioned file system 
from the file hierarchy.</p>
<p>For a macOS system, the <code>hdiutil detach</code> command detaches a disk image and 
terminates any associated processes.</p>
                            </p>
                        </div>
                    </div>









    


    



    <div class="row">
        <p>
            Execute the following script:
        </p>
    </div>
    <div class="row">
        <div class="col px-0">
            <pre>
                <code class="language-sql py-0">
MOUNT_PATH=&quot;{automationWorkerLinuxBaseDirectory}/build-winpe-iso/winimg&quot;

if [[ -f /etc/redhat-release ]] || [[ -f /etc/lsb-release ]] || [[ -f /etc/debian_version ]]
then

    if df -h | grep --ignore-case --quiet &quot;$(echo ${MOUNT_PATH}/*)&quot;
    then
    
        umount --verbose &quot;$(echo ${MOUNT_PATH}/*)&quot;
        chmod -R a+w &quot;${MOUNT_PATH}&quot;
    else
    
        echo &quot;${MOUNT_PATH} is not mounted. Skipping.&quot;
    fi
    
elif [[ &quot;Darwin&quot; == &quot;$(uname)&quot; ]]
then
    
    if [[ $(find ${MOUNT_PATH}/*  2&gt; /dev/null | wc -l) -gt 10 ]]
    then
    
        hdiutil detach $(echo ${MOUNT_PATH}/*)
    else
    
        echo &quot;${MOUNT_PATH} is not mounted. Skipping.&quot;
    fi
    
else
    
    echo &quot;Unsupported operating system.&quot;
    exit 1
fi
                </code>
            </pre>
        </div>
    </div>





    



                    <div class="row pt-5">
                        <h4 id="setwritepermissionstowinpeuefistagingonmacosorlinux">
                            <a href="#setwritepermissionstowinpeuefistagingonmacosorlinux">
                                <strong>Step 1.3 -</strong> Set Write Permissions to winpe_uefi_staging on macOS or Linux
                            </a>
                        </h4>
                    </div>

                    <div class="row">
                        <div class="description col px-0">
                            <p>
                                <p>The <code>chmod -R a+w</code> command modifies the permissions recursively for a directory 
and its contents. </p>
<p><code>-R</code> stands for recursive.</p>
<p><code>a</code> stands for all.</p>
<p><code>+</code> adds permissions.</p>
<p><code>w</code> stands for write.</p>
<p>This action is needed to delete the build directory.</p>
                            </p>
                        </div>
                    </div>









    


    



    <div class="row">
        <p>
            Execute the following script:
        </p>
    </div>
    <div class="row">
        <div class="col px-0">
            <pre>
                <code class="language-sql py-0">
DIR=&quot;{automationWorkerLinuxBaseDirectory}/build-winpe-iso&quot;

if [[ ! -d ${DIR} ]]
then

    echo &quot;Directory ${DIR} does not exist. Skipping.&quot;
else

    cd &quot;${DIR}&quot;
    UEFI_STAGING_DIR=&quot;winpe_uefi_staging&quot;
    
    if [[ ! -d ${UEFI_STAGING_DIR} ]]
    then
    
        echo &quot;Directory does not exist. Skipping.&quot;
    else
    
        echo &quot;Before&quot;
        ls -lh
        chmod -R a+w &quot;${UEFI_STAGING_DIR}&quot;
        
        echo &quot;After&quot;
        ls -lh
    fi
fi
                </code>
            </pre>
        </div>
    </div>





    



                    <div class="row pt-5">
                        <h4 id="deletethebuilddirectoryonmacosorlinux">
                            <a href="#deletethebuilddirectoryonmacosorlinux">
                                <strong>Step 1.4 -</strong> Delete the build directory on macOS or Linux
                            </a>
                        </h4>
                    </div>

                    <div class="row">
                        <div class="description col px-0">
                            <p>
                                <p>Delete any remaining build files.</p>
                            </p>
                        </div>
                    </div>










                        <div class="row">
                            <p>
                                Connect via ssh:
                            </p>
                        </div>
                        <div class="row py-1">
                            <code class="language-sql">
ssh {automationworkerlinuxuser}@{automationworkerlinuxnode}
                            </code>
                        </div>



    



    <div class="row">
        <p>
            Execute the following script:
        </p>
    </div>
    <div class="row">
        <div class="col px-0">
            <pre>
                <code class="language-sql py-0">
DIR=&quot;{automationWorkerLinuxBaseDirectory}/build-winpe-iso&quot;

if [ -d ${DIR} ]
then
    rm -rf ${DIR}
    echo &quot;Removed ${DIR}&quot;
else
    echo &quot;No directory to remove.&quot;
fi
                </code>
            </pre>
        </div>
    </div>






        



                    <div class="row pt-5">
                        <h3 id="deploywindowsdvdisotobuildwinpeisodirectoryonmacosorlinux">
                            <a href="#deploywindowsdvdisotobuildwinpeisodirectoryonmacosorlinux">
                                <strong>Step 2 -</strong> Deploy Windows DVD ISO to build-winpe-iso directory on macOS or Linux
                            </a>
                        </h3>
                    </div>

                    <div class="row">
                        <div class="description col px-0">
                            <p>
                                <p>You can extract necessary files from a Windows installation ISO to create a 
WinPE ISO. I've selected Win2019 to extract the WinPE ISO from.</p>
<p>Windows 10 Workstation ISO is not recommended as its WinPE has compatibility 
issues with the drvload-ing the vioscsi.inf oVirt driver.  </p>
<p>The WinPE from Win2016 and Win2022 has not been tested for <code>vioscsi.inf</code> 
compatibility.</p>
                            </p>
                        </div>
                    </div>









    

    



    <div class="row">
        <p>
            <p>Download from https://www.microsoft.com/en-us/evalcenter/download-windows-server-2019.</p>
        </p>
        <p>
            Copy the File(s)
            <strong>Win201_ISO.tar</strong>
            to the target node.
        </p>
        <p>
            <strong>Deploy the File(s)</strong> here:
        </p>
    </div>
    <div class="row py-1">
        <code class="language-bash">
{automationWorkerLinuxBaseDirectory}/build-winpe-iso, relative to the home directory
        </code>
    </div>





        



                    <div class="row pt-5">
                        <h3 id="extractwindowsbootimgfrombuildwinpeisodirectoryforbiosbuildonmacosorlinux">
                            <a href="#extractwindowsbootimgfrombuildwinpeisodirectoryforbiosbuildonmacosorlinux">
                                <strong>Step 3 -</strong> Extract Windows boot.img from build-winpe-iso directory for BIOS build on macOS or Linux
                            </a>
                        </h3>
                    </div>

                    <div class="row">
                        <div class="description col px-0">
                            <p>
                                <p>Set the shell option <code>nocaseglob</code> so that filenames will be matched regardless 
of their case.
Set the variable <code>F</code> to the list of filenames that end with 
<code>.iso</code> in the current directory.</p>
<p>The <code>isoinfo -d -i $F</code> command displays the details of the ISO image specified 
by <code>$F</code>. 
<code>grep Bootoff</code> filters this output to only include the line containing 
"Bootoff," which presumably contains information about the boot image offset.
<code>cut -c21-</code> extracts the characters starting from the 21st character of the 
line, which is assumed to be the offset value. 
The result is stored in the variable <code>OFFSET</code>.</p>
<p>The <code>dd</code> command is used for low-level copying of raw data.
<code>if=$F</code> specifies the input file, which is the ISO image.
<code>of=boot.img</code> sets the output file to <code>boot.img</code>.
<code>bs=2048</code> sets the block size to 2048 bytes. 
This is often the size of a sector in ISO9660 file systems.
<code>count=8</code> means only read 8 blocks (based on the block size).
<code>skip=$OFFSET</code> skips a number of blocks at the beginning of the input file 
before starting to copy, based on the calculated <code>OFFSET</code>.</p>
                            </p>
                        </div>
                    </div>









    


    



    <div class="row">
        <p>
            Execute the following script:
        </p>
    </div>
    <div class="row">
        <div class="col px-0">
            <pre>
                <code class="language-sql py-0">
cd {automationWorkerLinuxBaseDirectory}/build-winpe-iso

# Case insensitve globbing
shopt -s nocaseglob

# Set the filename of the ISO
F=$(ls *.iso)

# Get the Boot image offset
OFFSET=`isoinfo -d -i $F | grep Bootoff | cut  -c21-`

# Extract the boot.img
dd if=$F of=boot.img bs=2048 count=8 skip=$OFFSET
                </code>
            </pre>
        </div>
    </div>





        



                    <div class="row pt-5">
                        <h3 id="mountwinserverdvdisoonmacosorlinux">
                            <a href="#mountwinserverdvdisoonmacosorlinux">
                                <strong>Step 4 -</strong> Mount Win Server DVD ISO on macOS or Linux
                            </a>
                        </h3>
                    </div>

                    <div class="row">
                        <div class="description col px-0">
                            <p>
                                <p>For a linux system, the <code>mount</code> command attaches a file system found on a 
device. </p>
<p>For a macOS system, the <code>hdiutil attach</code> command attaches a disk image as a 
device. <code>-mountroot</code> mounts volumes on a subdirectory.</p>
                            </p>
                        </div>
                    </div>










                        <div class="row">
                            <p>
                                Connect via ssh:
                            </p>
                        </div>
                        <div class="row py-1">
                            <code class="language-sql">
ssh {automationworkerlinuxuserroot}@{automationworkerlinuxnode}
                            </code>
                        </div>



    



    <div class="row">
        <p>
            Execute the following script:
        </p>
    </div>
    <div class="row">
        <div class="col px-0">
            <pre>
                <code class="language-sql py-0">
cd &quot;{automationWorkerLinuxBaseDirectory}/build-winpe-iso&quot;
FOLDER=&quot;winimg&quot;
mkdir -p &quot;${FOLDER}&quot;

# Case insensitve globbing
shopt -s nocaseglob

ISO=$(ls *SERVER*.iso)

if [[ -f /etc/redhat-release ]] || [[ -f /etc/lsb-release ]] || [[ -f /etc/debian_version ]]
then

    mkdir -p &quot;${FOLDER}/CD&quot;
    mount --options &quot;uid={automationWorkerLinuxUser.user}&quot; \
        --options &quot;gid={automationWorkerLinuxUser.user}&quot; \
        &quot;${ISO}&quot; &quot;${FOLDER}/CD&quot;

elif [[ &quot;Darwin&quot; == &quot;$(uname)&quot; ]]
then

    hdiutil attach ${ISO} -mountroot ${FOLDER}

else

    echo &quot;Unsupported operating system.&quot;
    exit 1
fi
                </code>
            </pre>
        </div>
    </div>





        



                    <div class="row pt-5">
                        <h3 id="confirmmkwinpeimgisinstalled">
                            <a href="#confirmmkwinpeimgisinstalled">
                                <strong>Step 5 -</strong> Confirm mkwinpeimg is installed
                            </a>
                        </h3>
                    </div>

                    <div class="row">
                        <div class="description col px-0">
                            <p>
                                
                            </p>
                        </div>
                    </div>









    


    



    <div class="row">
        <p>
            Execute the following script:
        </p>
    </div>
    <div class="row">
        <div class="col px-0">
            <pre>
                <code class="language-sql py-0">
if [[ -f /etc/redhat-release ]] || [[ -f /etc/lsb-release ]]
then

    if which mkwinpeimg &gt;/dev/null; then
        echo &quot;mkwinpeimg is installed.&quot;
    else
        echo &quot;mkwinpeimg is not installed.&quot;
        dnf -y install wimlib wimlib-utils fuse
    fi

elif [[ -f /etc/debian_version ]]
then

    if which mkwinpeimg &gt;/dev/null; then
        echo &quot;mkwinpeimg is installed.&quot;
    else
        echo &quot;mkwinpeimg is not installed.&quot;
        apt-get -y install wimlib wimlib-utils fuse
    fi

elif [[ &quot;Darwin&quot; == &quot;$(uname)&quot; ]]
then

    if which mkwinpeimg &gt;/dev/null; then
        echo &quot;mkwinpeimg is installed.&quot;
    else
        echo &quot;mkwinpeimg is not installed.&quot;
        brew -y install wimlib
    fi

else
    
    echo &quot;Unsupported operating system.&quot;
    exit 1
fi
                </code>
            </pre>
        </div>
    </div>





        



                    <div class="row pt-5">
                        <h3 id="extractwinpeisofromwinimgdirectoryonmacosorlinux">
                            <a href="#extractwinpeisofromwinimgdirectoryonmacosorlinux">
                                <strong>Step 6 -</strong> Extract WinPE ISO from winimg Directory on macOS or Linux
                            </a>
                        </h3>
                    </div>

                    <div class="row">
                        <div class="description col px-0">
                            <p>
                                <p>Extracts the WinPE image from Windows Server 2019 <code>boot.wim</code> by default at index 2.</p>
<p>Writes this out to <code>winpe.iso</code>.</p>
<p>This is the exact copy of Windows Server 2019's WinPE image which by default will run <code>setup.exe</code> on the Windows Desktop ISO at a higher priority than running <code>startnet.cmd</code>.</p>
                            </p>
                        </div>
                    </div>










                        <div class="row">
                            <p>
                                Connect via ssh:
                            </p>
                        </div>
                        <div class="row py-1">
                            <code class="language-sql">
ssh {automationworkerlinuxuser}@{automationworkerlinuxnode}
                            </code>
                        </div>



    



    <div class="row">
        <p>
            Execute the following script:
        </p>
    </div>
    <div class="row">
        <div class="col px-0">
            <pre>
                <code class="language-sql py-0">
cd &quot;{automationWorkerLinuxBaseDirectory}/build-winpe-iso&quot;

if [[ &quot;Darwin&quot; == &quot;$(uname)&quot; ]]
then

    sed &#x27;s/getopt -o.*/getopt iso,windows-dir -- $*); then /g&#x27; $(which mkwinpeimg) \
        | sed &#x27;/-- &quot;$@&quot; /d&#x27; \
        | sed &#x27;/,help,version/d&#x27; \
        | sed &#x27;s/eval set -- &quot;$options&quot;/eval set &quot;$options&quot;/g&#x27; \
        &gt; mkwinpeimg
    which sed
    sed -i &#x27;s/while \[ $# -gt 0 \]; do/echo $*;while [ $# -gt 0 ]; do echo $1/g&#x27; mkwinpeimg
    chmod +x mkwinpeimg
    export PATH=&quot;.:$PATH&quot;
fi

mkwinpeimg --iso --windows-dir $(echo winimg/*) -- winpe.iso
                </code>
            </pre>
        </div>
    </div>





        



                    <div class="row pt-5">
                        <h3 id="extractwinpeisotostagingfolderonbuildwinpeisoonmacosorlinux">
                            <a href="#extractwinpeisotostagingfolderonbuildwinpeisoonmacosorlinux">
                                <strong>Step 7 -</strong> Extract WinPE ISO to Staging Folder on build-winpe-iso on macOS or Linux
                            </a>
                        </h3>
                    </div>

                    <div class="row">
                        <div class="description col px-0">
                            <p>
                                <p>Extract <code>winpe.iso</code> to a <code>winpe_staging</code> folder on macOS or Linux Worker.</p>
                            </p>
                        </div>
                    </div>









    


    



    <div class="row">
        <p>
            Execute the following script:
        </p>
    </div>
    <div class="row">
        <div class="col px-0">
            <pre>
                <code class="language-sql py-0">
cd {automationWorkerLinuxBaseDirectory}/build-winpe-iso

BIOS=winpe_bios_staging
UEFI=winpe_uefi_staging
mkdir -p &quot;${BIOS}&quot;
mkdir -p &quot;${UEFI}&quot;

7z x winpe.iso -o&quot;${BIOS}&quot;
7z x winpe.iso -o&quot;${UEFI}&quot;
                </code>
            </pre>
        </div>
    </div>





        



                    <div class="row pt-5">
                        <h3 id="copyfilesformkwinpeimgcompatibilitytowinpestagingonmacosorlinux">
                            <a href="#copyfilesformkwinpeimgcompatibilitytowinpestagingonmacosorlinux">
                                <strong>Step 8 -</strong> Copy Files for mkwinpeimg Compatibility to WinPE Staging on macOS or Linux
                            </a>
                        </h3>
                    </div>

                    <div class="row">
                        <div class="description col px-0">
                            <p>
                                <p>Copy the <code>boot/etfsboot.com</code> files from the Windows ISO to WinPE's <code>BOOT</code> 
folder.</p>
                            </p>
                        </div>
                    </div>










                        <div class="row">
                            <p>
                                Connect via ssh:
                            </p>
                        </div>
                        <div class="row py-1">
                            <code class="language-sql">
ssh {automationworkerlinuxuserroot}@{automationworkerlinuxnode}
                            </code>
                        </div>



    



    <div class="row">
        <p>
            Execute the following script:
        </p>
    </div>
    <div class="row">
        <div class="col px-0">
            <pre>
                <code class="language-sql py-0">
cd &quot;{automationWorkerLinuxBaseDirectory}/build-winpe-iso&quot;

cp -v &quot;$(find winimg -type f -name etfsboot.com)&quot; &quot;winpe_bios_staging/BOOT&quot;
cp -v &quot;$(find winimg -type f -name etfsboot.com)&quot; &quot;winpe_uefi_staging/BOOT&quot;
                </code>
            </pre>
        </div>
    </div>





        



                    <div class="row pt-5">
                        <h3 id="copybootimgtowinpestagingforbiosbuildonmacosorlinux">
                            <a href="#copybootimgtowinpestagingforbiosbuildonmacosorlinux">
                                <strong>Step 9 -</strong> Copy boot.img to winpe_staging for BIOS build on macOS or Linux
                            </a>
                        </h3>
                    </div>

                    <div class="row">
                        <div class="description col px-0">
                            <p>
                                <p>Moves <code>boot.img</code> to the <code>winpe_staging</code> folder.</p>
<p><code>mkisofs</code> requires <code>boot.img</code> to make a BIOS bootable ISO.</p>
                            </p>
                        </div>
                    </div>









    


    



    <div class="row">
        <p>
            Execute the following script:
        </p>
    </div>
    <div class="row">
        <div class="col px-0">
            <pre>
                <code class="language-sql py-0">
cd &quot;{automationWorkerLinuxBaseDirectory}/build-winpe-iso&quot;
cp -v boot.img winpe_bios_staging
                </code>
            </pre>
        </div>
    </div>





        



                    <div class="row pt-5">
                        <h3 id="lindeletesetupexefrombootwim">
                            <a href="#lindeletesetupexefrombootwim">
                                <strong>Step 10 -</strong> LIN Delete setup.exe from boot.wim
                            </a>
                        </h3>
                    </div>

                    <div class="row">
                        <div class="description col px-0">
                            <p>
                                <p>Deletes <code>setup.exe</code> from <code>{automationWorkerLinuxBaseDirectory}/build-winpe-iso/WinPE_BootImageDir</code>.</p>
                            </p>
                        </div>
                    </div>










                        <div class="row">
                            <p>
                                Connect via ssh:
                            </p>
                        </div>
                        <div class="row py-1">
                            <code class="language-sql">
ssh {automationworkerlinuxuser}@{automationworkerlinuxnode}
                            </code>
                        </div>



    



    <div class="row">
        <p>
            Execute the following script:
        </p>
    </div>
    <div class="row">
        <div class="col px-0">
            <pre>
                <code class="language-sql py-0">
cd {automationWorkerLinuxBaseDirectory}/build-winpe-iso/WinPE_BootImageDir

rm --verbose setup.exe
                </code>
            </pre>
        </div>
    </div>





        



                    <div class="row pt-5">
                        <h3 id="copywindowsefifilestowinpeuefistagingonmacosorlinux">
                            <a href="#copywindowsefifilestowinpeuefistagingonmacosorlinux">
                                <strong>Step 11 -</strong> Copy Windows EFI Files to WinPE UEFI Staging on macOS or Linux
                            </a>
                        </h3>
                    </div>

                    <div class="row">
                        <div class="description col px-0">
                            <p>
                                <p>To boot WinPE on a UEFI-based system, the ISO needs to include a 
UEFI-compatible boot loader and related files. Without this UEFI support, the 
WinPE ISO might not be able to boot on modern UEFI-enabled hardware.</p>
                            </p>
                        </div>
                    </div>









    


    



    <div class="row">
        <p>
            Execute the following script:
        </p>
    </div>
    <div class="row">
        <div class="col px-0">
            <pre>
                <code class="language-sql py-0">
cd &quot;{automationWorkerLinuxBaseDirectory}/build-winpe-iso&quot;
cp -rv &quot;$(echo winimg/*/efi)&quot; &quot;winpe_uefi_staging&quot;
                </code>
            </pre>
        </div>
    </div>





        



                    <div class="row pt-5">
                        <h3 id="createwinpeplainbiosisofromwinpestagingonmacosorlinux">
                            <a href="#createwinpeplainbiosisofromwinpestagingonmacosorlinux">
                                <strong>Step 12 -</strong> Create winpe_plain_bios.iso from winpe_staging on macOS or Linux
                            </a>
                        </h3>
                    </div>

                    <div class="row">
                        <div class="description col px-0">
                            <p>
                                <p>The <code>xorriso</code> and <code>mkisofs</code> command is used to create a customised, 
bootable ISO image from the contents of the winpe_staging directory. 
The command includes various settings for bootability, file system types, 
naming conventions, and compatibility options to ensure the ISO functions as 
intended in various environments. </p>
<p>Let's break down the command and its options:</p>
<p><code>xorriso -as mkisofs</code> runs xorriso in a mode that emulates <code>mkisofs</code>, 
a linux command.</p>
<p><code>-b boot.img</code> specifies boot.img as the boot image for a bootable ISO. </p>
<p><code>-no-emul-boot</code> indicates that no disk emulation mode is used for the boot 
image. This is typically used for bootable ISOs intended for systems that 
can understand the ISO file system directly.</p>
<p><code>-c BOOT.CAT</code> specifies the creation of a boot catalog (BOOT.CAT) in the 
ISO image.</p>
<p><code>-iso-level 3</code> sets the compliance level for the ISO 9660 standard. 
Level 3 allows for file names up to 207 characters in length and file 
sizes larger than 2 GB.</p>
<p><code>-udf</code> includes UDF (Universal Disk Format) file system in 
addition to ISO 9660. UDF is often used for DVDs and newer 
optical media formats and supports larger file sizes.</p>
<p><code>-joliet-long</code> Enables the use of the Joliet file system extension 
with support for longer file names.</p>
<p><code>-relaxed-filenames</code> allows file names that do not strictly adhere to the 
ISO 9660 standard, providing more flexibility.</p>
<p><code>-allow-limited-size</code> permits the creation of ISO images that exceed the 
size limitations of the ISO 9660 standard.</p>
<p><code>-J</code> enables Joliet file system extensions for longer file names and 
Unicode characters.</p>
<p><code>-full-iso9660-filenames</code> allows using the full ISO 9660 file naming 
rules without the usual length limitations.</p>
<p><code>-disable-deep-relocation</code> disables the relocation of deep directory 
trees, which can be necessary for certain boot scenarios.</p>
<p><code>-omit-version-number</code> omits the version number from file names in the 
ISO image.</p>
<p><code>-V</code> sets the volume ID of the ISO image.</p>
<p><code>-o</code> specifies the output path and filename for the created ISO image.</p>
                            </p>
                        </div>
                    </div>









    


    



    <div class="row">
        <p>
            Execute the following script:
        </p>
    </div>
    <div class="row">
        <div class="col px-0">
            <pre>
                <code class="language-sql py-0">
cd &quot;{automationWorkerLinuxBaseDirectory}/build-winpe-iso&quot;

ISO_NAME=&quot;winpe_plain_bios.iso&quot;

if [[ &quot;Darwin&quot; == &quot;$(uname)&quot; ]]
then
    
    export PATH=&quot;${HOME}/Parallels/homebrew/bin:$PATH&quot;
    echo &quot;Using $(which xorriso)&quot;

    xorriso -as mkisofs \
        -b boot.img \
        -no-emul-boot \
        -c BOOT.CAT \
        -iso-level 3 \
        -joliet-long \
        -relaxed-filenames \
        -J \
        -full-iso9660-filenames \
        -disable-deep-relocation \
        -omit-version-number \
        -V &quot;KS_WIN&quot; \
        -o &quot;{automationWorkerLinuxBaseDirectory}/${ISO_NAME}&quot; \
        winpe_bios_staging
        
elif [[ -f /etc/redhat-release ]] || [[ -f /etc/lsb-release ]] || [[ -f /etc/debian_version ]]
then

    mkisofs \
        -b boot.img \
        -no-emul-boot \
        -c BOOT.CAT \
        -iso-level 3 \
        -udf \
        -joliet-long \
        -relaxed-filenames \
        -allow-limited-size \
        -J \
        -full-iso9660-filenames \
        -disable-deep-relocation \
        -omit-version-number \
        -V &quot;KS_WIN&quot; \
        -o &quot;{automationWorkerLinuxBaseDirectory}/${ISO_NAME}&quot; \
        winpe_bios_staging

else

    echo &quot;Unsupported operating system.&quot;
    exit 1
fi
                </code>
            </pre>
        </div>
    </div>





        



                    <div class="row pt-5">
                        <h3 id="createfat32winpeplainuefiisofromwinpestagingonlinuxworker">
                            <a href="#createfat32winpeplainuefiisofromwinpestagingonlinuxworker">
                                <strong>Step 13 -</strong> Create FAT32 winpe_plain_uefi.iso from winpe_staging on Linux Worker
                            </a>
                        </h3>
                    </div>

                    <div class="row">
                        <div class="description col px-0">
                            <p>
                                
                            </p>
                        </div>
                    </div>





    




    



                    <div class="row pt-5">
                        <h4 id="changeownershipofwinpestagingdirectorytoattune">
                            <a href="#changeownershipofwinpestagingdirectorytoattune">
                                <strong>Step 13.1 -</strong> Change Ownership of winpe_staging Directory to attune
                            </a>
                        </h4>
                    </div>

                    <div class="row">
                        <div class="description col px-0">
                            <p>
                                
                            </p>
                        </div>
                    </div>










                        <div class="row">
                            <p>
                                Connect via ssh:
                            </p>
                        </div>
                        <div class="row py-1">
                            <code class="language-sql">
ssh {automationworkerlinuxuserroot}@{automationworkerlinuxnode}
                            </code>
                        </div>



    



    <div class="row">
        <p>
            Execute the following script:
        </p>
    </div>
    <div class="row">
        <div class="col px-0">
            <pre>
                <code class="language-sql py-0">
if {kickstartedBootLoaderIsUefi}
then
    if uname | \
        grep -iq &quot;darwin&quot;
    then
        echo &quot;is macOS, skipping&quot;
        
    else
        echo &quot;not macOS&quot;
        
        cd &quot;{automationWorkerLinuxBaseDirectory}/build-winpe-iso&quot;
        
        chown --recursive \
            --verbose \
            &quot;{automationWorkerLinuxUser.user}:{automationWorkerLinuxUser.user}&quot; \
            &quot;winpe_staging&quot;
    fi
else
    echo &quot;Skipping for BIOS boot.&quot;
fi
                </code>
            </pre>
        </div>
    </div>





    



                    <div class="row pt-5">
                        <h4 id="createwinpeplainuefiiso">
                            <a href="#createwinpeplainuefiiso">
                                <strong>Step 13.2 -</strong> Create winpe_plain_uefi.iso
                            </a>
                        </h4>
                    </div>

                    <div class="row">
                        <div class="description col px-0">
                            <p>
                                <p>Referenced from https://apple.stackexchange.com/questions/394372/create-file-that-can-be-mounted</p>
<p>On macOS to see all available filesystems for the <code>-fs</code> switch use:</p>
<pre><code>hdiutil create -help
</code></pre>
                            </p>
                        </div>
                    </div>










                        <div class="row">
                            <p>
                                Connect via ssh:
                            </p>
                        </div>
                        <div class="row py-1">
                            <code class="language-sql">
ssh {automationworkerlinuxuser}@{automationworkerlinuxnode}
                            </code>
                        </div>



    



    <div class="row">
        <p>
            Execute the following script:
        </p>
    </div>
    <div class="row">
        <div class="col px-0">
            <pre>
                <code class="language-sql py-0">
if {kickstartedBootLoaderIsUefi}
then
    
    cd &quot;{automationWorkerLinuxBaseDirectory}&quot;
    rm -rf winpe_plain_uefi.iso
    
    if uname | \
        grep -iq &quot;darwin&quot;
    then
        echo &quot;is macOS, skipping&quot;
        
    else
        echo &quot;not macOS&quot;
        
        cd &quot;{automationWorkerLinuxBaseDirectory}/build-winpe-iso&quot;
        
        bytes=$(du --summarize winpe_staging | awk &#x27;{print $1}&#x27;)
        ((bytes=bytes+10000))
        
        ISO=&quot;{automationWorkerLinuxBaseDirectory}/winpe_plain_uefi.iso&quot;
        mkfs.msdos -v -C &quot;${ISO}&quot; &quot;${bytes}&quot;
    fi
    
else
    echo &quot;Skipping for BIOS boot.&quot;
fi
                </code>
            </pre>
        </div>
    </div>





    



                    <div class="row pt-5">
                        <h4 id="mountwinpeplainuefiiso">
                            <a href="#mountwinpeplainuefiiso">
                                <strong>Step 13.3 -</strong> Mount winpe_plain_uefi.iso
                            </a>
                        </h4>
                    </div>

                    <div class="row">
                        <div class="description col px-0">
                            <p>
                                
                            </p>
                        </div>
                    </div>










                        <div class="row">
                            <p>
                                Connect via ssh:
                            </p>
                        </div>
                        <div class="row py-1">
                            <code class="language-sql">
ssh {automationworkerlinuxuserroot}@{automationworkerlinuxnode}
                            </code>
                        </div>



    



    <div class="row">
        <p>
            Execute the following script:
        </p>
    </div>
    <div class="row">
        <div class="col px-0">
            <pre>
                <code class="language-sql py-0">
if {kickstartedBootLoaderIsUefi}
then
    if uname | \
        grep -iq &quot;darwin&quot;
    then
        echo &quot;is macOS, skipping&quot;
        
    else
        echo &quot;not macOS&quot;
        
        cd &quot;{automationWorkerLinuxBaseDirectory}/build-winpe-iso&quot;
        
        mkdir --parents --verbose uefi_mount
        
        mount --verbose \
            &quot;../winpe_plain_uefi.iso&quot; uefi_mount
    fi
    
else
    echo &quot;Skipping for BIOS boot.&quot;
fi
                </code>
            </pre>
        </div>
    </div>





    



                    <div class="row pt-5">
                        <h4 id="movewinpestagingtouefimount">
                            <a href="#movewinpestagingtouefimount">
                                <strong>Step 13.4 -</strong> Move WinPE Staging to UEFI Mount
                            </a>
                        </h4>
                    </div>

                    <div class="row">
                        <div class="description col px-0">
                            <p>
                                
                            </p>
                        </div>
                    </div>









    


    



    <div class="row">
        <p>
            Execute the following script:
        </p>
    </div>
    <div class="row">
        <div class="col px-0">
            <pre>
                <code class="language-sql py-0">
if {kickstartedBootLoaderIsUefi}
then
    if uname | \
        grep -iq &quot;darwin&quot;
    then
        echo &quot;is macOS, skipping&quot;
        
    else
        echo &quot;not macOS&quot;
        
        cd &quot;{automationWorkerLinuxBaseDirectory}/build-winpe-iso&quot;
        
        # Copy WinPE Files from WinPE ISO
        mv --verbose winpe_staging/* &quot;uefi_mount&quot;
    fi
else
    echo &quot;Skipping for BIOS boot.&quot;
fi
                </code>
            </pre>
        </div>
    </div>





    



                    <div class="row pt-5">
                        <h4 id="unmountwinpeuefimountonmacosorlinux">
                            <a href="#unmountwinpeuefimountonmacosorlinux">
                                <strong>Step 13.5 -</strong> Unmount WinPE UEFI Mount on macOS or Linux
                            </a>
                        </h4>
                    </div>

                    <div class="row">
                        <div class="description col px-0">
                            <p>
                                <p>For a linux system, the <code>umount</code> command detaches the mentioned file system 
from the file hierarchy.</p>
<p>For a macOS system, the <code>hdiutil detach</code> command detaches a disk image and 
terminates any associated processes.</p>
                            </p>
                        </div>
                    </div>









    


    



    <div class="row">
        <p>
            Execute the following script:
        </p>
    </div>
    <div class="row">
        <div class="col px-0">
            <pre>
                <code class="language-sql py-0">
MOUNT_PATH=&quot;{automationWorkerLinuxBaseDirectory}/build-winpe-iso/uefi_mount&quot;

if [[ -f /etc/redhat-release ]] || [[ -f /etc/lsb-release ]] || [[ -f /etc/debian_version ]]
then
    
    if df -h | grep --ignore-case --quiet &quot;$(echo ${MOUNT_PATH}/*)&quot;
    then
    
        umount --verbose &quot;$(echo ${MOUNT_PATH}/*)&quot;
        chmod -R a+w &quot;${MOUNT_PATH}&quot;
        
    else
    
        echo &quot;${MOUNT_PATH} is not mounted. Skipping.&quot;
    fi

elif [[ &quot;Darwin&quot; == &quot;$(uname)&quot; ]]
then

    if [[ $(find ${MOUNT_PATH}/*  2&gt; /dev/null | wc -l) -gt 10 ]]
    then
    
        hdiutil detach &quot;$(echo ${MOUNT_PATH}/*)&quot;
    else
    
        echo &quot;${MOUNT_PATH} is not mounted. Skipping.&quot;
    fi

else
    
    echo &quot;Unsupported operating system.&quot;
    exit 1
fi
                </code>
            </pre>
        </div>
    </div>






        



                    <div class="row pt-5">
                        <h3 id="createwinpeplainuefiisoonmacosworker">
                            <a href="#createwinpeplainuefiisoonmacosworker">
                                <strong>Step 14 -</strong> Create winpe_plain_uefi.iso on macOS Worker
                            </a>
                        </h3>
                    </div>

                    <div class="row">
                        <div class="description col px-0">
                            <p>
                                <p>Creates the UEFI bootable WinPE ISO if <code>kickstartedBootLoaderIsUefi</code> is true on macOS Worker.</p>
                            </p>
                        </div>
                    </div>










                        <div class="row">
                            <p>
                                Connect via ssh:
                            </p>
                        </div>
                        <div class="row py-1">
                            <code class="language-sql">
ssh {automationworkerlinuxuser}@{automationworkerlinuxnode}
                            </code>
                        </div>



    



    <div class="row">
        <p>
            Execute the following script:
        </p>
    </div>
    <div class="row">
        <div class="col px-0">
            <pre>
                <code class="language-sql py-0">
if {kickstartedBootLoaderIsUefi}
then

    if uname | \
        grep -iq &quot;darwin&quot;
    then
        echo &quot;is macOS&quot;
        export PATH=&quot;${HOME}/Parallels/homebrew/bin:$PATH&quot;
        echo &quot;Using $(which xorriso)&quot;
        
        cd &quot;{automationWorkerLinuxBaseDirectory}/build-winpe-iso&quot;
        
        ISO=&quot;{automationWorkerLinuxBaseDirectory}/winpe_plain_uefi.iso&quot;
        echo &quot;ISO=${ISO}&quot;
        
        xorriso -as mkisofs \
            -iso-level 4 \
            -full-iso9660-filenames \
            -rock \
            -b BOOT/etfsboot.com \
            -no-emul-boot \
            -boot-load-size 8 \
            -hide boot.catalog \
            -eltorito-alt-boot \
            -no-emul-boot \
            -b efi/microsoft/boot/efisys.bin \
            -boot-load-size 1 \
            -untranslated-filenames \
            -disable-deep-relocation \
            -o &quot;${ISO}&quot; \
            winpe_staging
    else
        echo &quot;not macOS, skipping&quot;
    fi
    
else
    echo &quot;Skipping for BIOS boot.&quot;
fi
                </code>
            </pre>
        </div>
    </div>





        



                    <div class="row pt-5">
                        <h3 id="cleanuptemporarybuildfilesforwinpeplainisocreationonmacosorlinux">
                            <a href="#cleanuptemporarybuildfilesforwinpeplainisocreationonmacosorlinux">
                                <strong>Step 15 -</strong> Cleanup temporary build files for WinPE plain ISO creation on macOS or Linux
                            </a>
                        </h3>
                    </div>

                    <div class="row">
                        <div class="description col px-0">
                            <p>
                                <p>Unmount any existing WinPE or Windows ISO mounts. </p>
<p>Set appropriate write permissions to enable modifications in the 
working directory.</p>
<p>Delete any remaining build files.</p>
                            </p>
                        </div>
                    </div>





    




    



                    <div class="row pt-5">
                        <h4 id="unmountwinpeuefimountonmacosorlinux">
                            <a href="#unmountwinpeuefimountonmacosorlinux">
                                <strong>Step 15.1 -</strong> Unmount WinPE UEFI Mount on macOS or Linux
                            </a>
                        </h4>
                    </div>

                    <div class="row">
                        <div class="description col px-0">
                            <p>
                                <p>For a linux system, the <code>umount</code> command detaches the mentioned file system 
from the file hierarchy.</p>
<p>For a macOS system, the <code>hdiutil detach</code> command detaches a disk image and 
terminates any associated processes.</p>
                            </p>
                        </div>
                    </div>










                        <div class="row">
                            <p>
                                Connect via ssh:
                            </p>
                        </div>
                        <div class="row py-1">
                            <code class="language-sql">
ssh {automationworkerlinuxuserroot}@{automationworkerlinuxnode}
                            </code>
                        </div>



    



    <div class="row">
        <p>
            Execute the following script:
        </p>
    </div>
    <div class="row">
        <div class="col px-0">
            <pre>
                <code class="language-sql py-0">
MOUNT_PATH=&quot;{automationWorkerLinuxBaseDirectory}/build-winpe-iso/uefi_mount&quot;

if [[ -f /etc/redhat-release ]] || [[ -f /etc/lsb-release ]] || [[ -f /etc/debian_version ]]
then
    
    if df -h | grep --ignore-case --quiet &quot;$(echo ${MOUNT_PATH}/*)&quot;
    then
    
        umount --verbose &quot;$(echo ${MOUNT_PATH}/*)&quot;
        chmod -R a+w &quot;${MOUNT_PATH}&quot;
        
    else
    
        echo &quot;${MOUNT_PATH} is not mounted. Skipping.&quot;
    fi

elif [[ &quot;Darwin&quot; == &quot;$(uname)&quot; ]]
then

    if [[ $(find ${MOUNT_PATH}/*  2&gt; /dev/null | wc -l) -gt 10 ]]
    then
    
        hdiutil detach &quot;$(echo ${MOUNT_PATH}/*)&quot;
    else
    
        echo &quot;${MOUNT_PATH} is not mounted. Skipping.&quot;
    fi

else
    
    echo &quot;Unsupported operating system.&quot;
    exit 1
fi
                </code>
            </pre>
        </div>
    </div>





    



                    <div class="row pt-5">
                        <h4 id="unmountwindowsisoonmacosorlinux">
                            <a href="#unmountwindowsisoonmacosorlinux">
                                <strong>Step 15.2 -</strong> Unmount Windows ISO on macOS or Linux
                            </a>
                        </h4>
                    </div>

                    <div class="row">
                        <div class="description col px-0">
                            <p>
                                <p>For a linux system, the <code>umount</code> command detaches the mentioned file system 
from the file hierarchy.</p>
<p>For a macOS system, the <code>hdiutil detach</code> command detaches a disk image and 
terminates any associated processes.</p>
                            </p>
                        </div>
                    </div>









    


    



    <div class="row">
        <p>
            Execute the following script:
        </p>
    </div>
    <div class="row">
        <div class="col px-0">
            <pre>
                <code class="language-sql py-0">
MOUNT_PATH=&quot;{automationWorkerLinuxBaseDirectory}/build-winpe-iso/winimg&quot;

if [[ -f /etc/redhat-release ]] || [[ -f /etc/lsb-release ]] || [[ -f /etc/debian_version ]]
then

    if df -h | grep --ignore-case --quiet &quot;$(echo ${MOUNT_PATH}/*)&quot;
    then
    
        umount --verbose &quot;$(echo ${MOUNT_PATH}/*)&quot;
        chmod -R a+w &quot;${MOUNT_PATH}&quot;
    else
    
        echo &quot;${MOUNT_PATH} is not mounted. Skipping.&quot;
    fi
    
elif [[ &quot;Darwin&quot; == &quot;$(uname)&quot; ]]
then
    
    if [[ $(find ${MOUNT_PATH}/*  2&gt; /dev/null | wc -l) -gt 10 ]]
    then
    
        hdiutil detach $(echo ${MOUNT_PATH}/*)
    else
    
        echo &quot;${MOUNT_PATH} is not mounted. Skipping.&quot;
    fi
    
else
    
    echo &quot;Unsupported operating system.&quot;
    exit 1
fi
                </code>
            </pre>
        </div>
    </div>





    



                    <div class="row pt-5">
                        <h4 id="setwritepermissionstowinpeuefistagingonmacosorlinux">
                            <a href="#setwritepermissionstowinpeuefistagingonmacosorlinux">
                                <strong>Step 15.3 -</strong> Set Write Permissions to winpe_uefi_staging on macOS or Linux
                            </a>
                        </h4>
                    </div>

                    <div class="row">
                        <div class="description col px-0">
                            <p>
                                <p>The <code>chmod -R a+w</code> command modifies the permissions recursively for a directory 
and its contents. </p>
<p><code>-R</code> stands for recursive.</p>
<p><code>a</code> stands for all.</p>
<p><code>+</code> adds permissions.</p>
<p><code>w</code> stands for write.</p>
<p>This action is needed to delete the build directory.</p>
                            </p>
                        </div>
                    </div>









    


    



    <div class="row">
        <p>
            Execute the following script:
        </p>
    </div>
    <div class="row">
        <div class="col px-0">
            <pre>
                <code class="language-sql py-0">
DIR=&quot;{automationWorkerLinuxBaseDirectory}/build-winpe-iso&quot;

if [[ ! -d ${DIR} ]]
then

    echo &quot;Directory ${DIR} does not exist. Skipping.&quot;
else

    cd &quot;${DIR}&quot;
    UEFI_STAGING_DIR=&quot;winpe_uefi_staging&quot;
    
    if [[ ! -d ${UEFI_STAGING_DIR} ]]
    then
    
        echo &quot;Directory does not exist. Skipping.&quot;
    else
    
        echo &quot;Before&quot;
        ls -lh
        chmod -R a+w &quot;${UEFI_STAGING_DIR}&quot;
        
        echo &quot;After&quot;
        ls -lh
    fi
fi
                </code>
            </pre>
        </div>
    </div>





    



                    <div class="row pt-5">
                        <h4 id="deletethebuilddirectoryonmacosorlinux">
                            <a href="#deletethebuilddirectoryonmacosorlinux">
                                <strong>Step 15.4 -</strong> Delete the build directory on macOS or Linux
                            </a>
                        </h4>
                    </div>

                    <div class="row">
                        <div class="description col px-0">
                            <p>
                                <p>Delete any remaining build files.</p>
                            </p>
                        </div>
                    </div>










                        <div class="row">
                            <p>
                                Connect via ssh:
                            </p>
                        </div>
                        <div class="row py-1">
                            <code class="language-sql">
ssh {automationworkerlinuxuser}@{automationworkerlinuxnode}
                            </code>
                        </div>



    



    <div class="row">
        <p>
            Execute the following script:
        </p>
    </div>
    <div class="row">
        <div class="col px-0">
            <pre>
                <code class="language-sql py-0">
DIR=&quot;{automationWorkerLinuxBaseDirectory}/build-winpe-iso&quot;

if [ -d ${DIR} ]
then
    rm -rf ${DIR}
    echo &quot;Removed ${DIR}&quot;
else
    echo &quot;No directory to remove.&quot;
fi
                </code>
            </pre>
        </div>
    </div>







                    <div class="row pt-5">
                        <div class="col">
                            <h2>Completed</h2>
                            <p>
                                You have completed this instruction.
                            </p>
                        </div>
                    </div>
                </div>
            </div>

<!-- Download Attune Ad -->

            <div class="toc col-lg-2 px-0">
                <div class="container px-0 pt-3 pl-5">
                    <div class="card border-light mb-3" style="max-width: 18rem;">
                        <div class="card-body attune-ad">
                            <img
                                src="https://www.servertribe.com/wp-content/uploads/2022/06/AttuneLogoV2_powered_by.png"
                                alt="Attune - Powered by ServerTribe"
                                class="img-fluid">
                            <p class="card-title mt-3 text-center">
                                <strong>Automate with Attune</strong>
                            </p>
                            <p class="card-text text-center">
                                Download the Attune Community Edition.
                            </p>
                            <p class="text-center">
                                <a href="https://www.servertribe.com/download-attune-registration/"
                                   class="btn btn-primary mt-3">
                                    DOWNLOAD!!!
                                </a>
                            </p>
                        </div>
                    </div>
                </div>
            </div>

        </div>

<!-- Join Discord -->

        <div class="row py-5">
            <div class="jumbotron">
              <h1 class="display-4 text-center">
                  Discuss this Project in Discord
              </h1>
              <p class="lead">

                  Join our Discord channel and connect with like-minded individuals who
                  share your passion. Engage in lively discussions, gain valuable insights,
                  and stay updated on the latest trends in our industry. Don't miss out on
                  this opportunity to network, learn, and grow together.
              </p>
              <hr class="my-4 text-center">
                <div class="col px-0">
                  <p class="text-center">
                      Click the link below and become a part of our vibrant community on
                      Discord today!
                  </p>
                  <p class="lead text-center">
                    <a class="btn btn-primary btn-lg"
                       href="https://discord.com/invite/3YpJsagqUn"
                       role="button">
                        Join NOW!!!
                    </a>
                  </p>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- Project Footer -->

<footer class="footer fixed-bottom bg-white border-top box-shadow">
      <div class="container px-0">
          <div class="row">
              <div class="col px-0">
                  <a class="my-0 mr-lg-auto"
                     href="https://www.servertribe.com/"
                     target="_blank">
                      <img
                          src="https://www.servertribe.com/wp-content/uploads/2022/06/AttuneLogoV2_powered_by.png"
                          alt="Attune - Powered by ServerTribe"
                          class="img-fluid navbar-img">
                  </a>
              </div>
          </div>
      </div>
</footer>


<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
        integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
        crossorigin="anonymous"></script>
<script
    src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js"
    integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
    crossorigin="anonymous"></script>
<script
    src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js"
    integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
    crossorigin="anonymous"></script>

<script
    src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>

<script
    src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
<script
    src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>


</body>
</html>
