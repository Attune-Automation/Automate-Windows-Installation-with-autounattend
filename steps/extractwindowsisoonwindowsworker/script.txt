$ISO_BUILD="C:\attuneautomationworker"
$BUILD_DIR="$ISO_BUILD\build-{newOsNode.fqn}"

Set-Location $BUILD_DIR

$scriptContent=@'
# Case insensitve globbing
shopt -s nocaseglob;

# Set the filename of the ISO
if ls | grep -q *iso;
then
  ISO="$(echo *iso)";
  echo "ISO is $ISO";

  7z x "${ISO}"

  rm -v "${ISO}"
else
  echo "ISO is already extracted.";
fi
'@

$FILE = "tmpBash.sh"

Set-Content -Path $FILE -NoNewline -Value $scriptContent

# Replace CRLF with LF
$text = [IO.File]::ReadAllText("$BUILD_DIR\$FILE") -replace "`r`n", "`n"
[IO.File]::WriteAllText("$BUILD_DIR\$FILE", $text)

wsl -d Ubuntu --user {wsl2AutomationWorkerLinuxUser.user} --exec bash "${FILE}"

if ($LASTEXITCODE -ne 0) {
  Write-Error 'Failed to extract ISO'
}
  
Remove-Item "${FILE}"
