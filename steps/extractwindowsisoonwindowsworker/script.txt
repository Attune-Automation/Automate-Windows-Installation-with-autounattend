$ISO_BUILD="C:\attuneautomationworker"
$BUILD_DIR="$ISO_BUILD\build-{newOsNode.fqn}"

Set-Location $BUILD_DIR

$ISO="*.iso"

$scriptContent=@'
# Case insensitve globbing
shopt -s nocaseglob;

# Set the filename of the ISO
if ls | grep -q *iso;
then
  ISO="$(echo *iso)";
  echo "ISO is $ISO";

  7z x "${ISO}"

  rm -v "${ISO}"
else
  echo "ISO is already extracted.";
fi
'@

# Replace CRLF with LF
$scriptContent = $scriptContent.replace("`r`n","`n")
    
$FILE = "attune_wsl_extract_iso.sh"

Set-Content -Path $FILE -NoNewline -Value $scriptContent

wsl -d Ubuntu --user {wsl2AutomationWorkerLinuxUser.user} --exec bash "${FILE}"

if ($LASTEXITCODE -ne 0) {
  Write-Error 'Failed to extract ISO'
}
  
Remove-Item "${FILE}"
