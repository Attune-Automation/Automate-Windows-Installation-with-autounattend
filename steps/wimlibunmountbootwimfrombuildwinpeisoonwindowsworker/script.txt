$ISO_BUILD="C:\attuneautomationworker"
$BUILD_DIR="$ISO_BUILD\build-winpe-iso"

Set-Location $BUILD_DIR

  $scriptContent=@'
wimunmount WinPE_BootImageDir --commit --check --rebuild
'@

# Replace CRLF with LF
$scriptContent = $scriptContent.replace("`r`n","`n")

$FILE = "attune_wsl_unmount_boot_wim_directory.sh"

Set-Content -Path $FILE -NoNewline -Value $scriptContent

wsl -d Ubuntu --user {wsl2AutomationWorkerLinuxUser.user} --exec bash "${FILE}"

if ($LASTEXITCODE -ne 0) {
    Write-Error 'Failed to extract boot.img'
}

Remove-Item "${FILE}"